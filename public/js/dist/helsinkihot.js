var LabelOverlay=function(a){this._map=a;this.setMap(a)};LabelOverlay.prototype=new google.maps.OverlayView;
LabelOverlay.prototype.addLabel=function(a){var b=a.name,c=a.latitude,a=a.longitude,a=this.getProjection().fromLatLngToDivPixel(new google.maps.LatLng(c,a));console.log(b+" x: "+a.x+", y: "+a.y);console.log(a);var c=a.x-this._left,a=a.y-this._top,d=$('<div class="label-overlay" style="position: absolute;">'+b+"</div>");d.css({left:c,top:a-100,opacity:0});this.$div.append(d);d.animate({opacity:1,top:"+=100"},1E3);setTimeout(function(){d.animate({opacity:0},1E3,function(){d.remove()})},5E3)};
LabelOverlay.prototype.onAdd=function(){this.$div=$("<div></div>");this._div=this.$div.get(0);this.getPanes().overlayLayer.appendChild(this._div);this._div.style.position="absolute";var a=this.getProjection(),b=a.fromLatLngToDivPixel(new google.maps.LatLng(60.255486,24.729538)),a=a.fromLatLngToDivPixel(new google.maps.LatLng(60.12988,25.089684));this._div.style.left=b.x+"px";this._div.style.top=b.y+"px";this._div.style.width=a.x-b.x+"px";this._div.style.height=a.y-b.y+"px";this._left=b.x;this._top=
b.y};LabelOverlay.prototype.draw=function(){var a=this.getProjection(),b=a.fromLatLngToDivPixel(new google.maps.LatLng(60.255486,24.729538)),a=a.fromLatLngToDivPixel(new google.maps.LatLng(60.12988,25.089684));this._div.style.left=b.x+"px";this._div.style.top=b.y+"px";this._div.style.width=a.x-b.x+"px";this._div.style.height=a.y-b.y+"px";this._left=b.x;this._top=b.y};LabelOverlay.prototype.onRemove=function(){};var map,heatmap,labelOverlay;function log(a){window.console&&console.log&&console.log(a)}function parseAnchorFromUrl(){var a=window.location.hash;if(a.length!==0)return a.substr(1)}function initializeConsole(){parseAnchorFromUrl()==="console"&&($("#sidebar").show(),$("#sidebar-bg").show())}function showLoader(a){a?(log("Show loader"),$("<div id='loader'>Loading venues</div>").hide().appendTo("body").fadeIn("slow")):(log("Hide loader"),$("#loader").fadeOut("slow",function(){$(this).remove()}))}
function initializeHeatmap(){heatmap=new Heatmap(map)}function initializeLabelOverlay(){labelOverlay=new LabelOverlay(map)}
function initializeMap(){var a=new google.maps.LatLng(60.170833,24.9375),b=new google.maps.StyledMapType([{featureType:"all",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"all",elementType:"all",stylers:[{lightness:10}]},{featureType:"administrative.locality",elementType:"labels",stylers:[{visibility:"on"}]}],{name:"HelsinkiHot custom"}),a={zoom:11,minZoom:11,maxZoom:18,center:a,disableDefaultUI:!0,mapTypeControl:!0,zoomControl:!0,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,
google.maps.MapTypeId.SATELLITE,"custom"]}};map=new google.maps.Map(document.getElementById("map_canvas"),a);map.mapTypes.set("custom",b);map.setMapTypeId(google.maps.MapTypeId.ROADMAP)}
function addVenue(a,b,c){var d=new google.maps.LatLng(a.latitude,a.longitude),f=a.events[a.events.length>0?a.events.length-1:0];c&&labelOverlay.addLabel(a);heatmap.addHotspot(d,f.points);b&&(log("Panning"),map.panTo(d),heatmap.draw(),b=new google.maps.Marker({position:d,map:map,animation:google.maps.Animation.DROP}),google.maps.event.addListener(b,"mousemove",function(){$hoverBox.html(a.name+" <span class='count'>"+f.points+"</span>").fadeIn("fast").css({left:event.clientX+10,top:event.clientY})}),
google.maps.event.addListener(b,"mouseout",function(){$hoverBox.fadeOut()}))}function showPolledForsquareData(a){a.length===0&&alert("No events found! Try increasing time span.");$(a).each(function(a,c){a<200&&addVenue(c)});heatmap.draw()}function getVenueData(a){showLoader(!0);a||(a=1);var b=new Date;b.setHours(b.getHours()-a);$.ajax({type:"GET",url:"api/venues/since/"+b.getTime(),success:function(a){showPolledForsquareData(a.venues);showLoader(!1)}})}
$(document).ready(function(){initializeMap();initializeHeatmap();initializeLabelOverlay();initializeConsole();getVenueData(1);$("#hoursSlider").slider({min:1,max:24,value:1,range:"min",change:function(a,b){heatmap._hotspots=[];getVenueData(b.value)}});$("#radiusSlider").slider({min:5,max:100,value:Heatmap.DEFAULT_RADIUS,range:"min",slide:function(a,b){heatmap.setRadius(b.value);heatmap.draw()}});$("#alphaMultiplySlider").slider({min:0.1,max:5,step:0.1,value:Heatmap.DEFAULT_ALPHA_MULTIPLIER,range:"min",
slide:function(a,b){multiply=b.value;heatmap.setHeatMultiplier(b.value);heatmap.draw()}});$hoverBox=$("<div class='hoverBox'>").appendTo("#map_container").hide().css({position:"fixed",left:0,top:0,"z-index":1E3});$("#authorInfo a#inline").fancybox();$("#likeLink").hover(function(){$("#likes").slideDown()},function(){$("#likes").slideUp()});$(window).bind("hashchange",function(){initializeConsole()})});
function notification(a){var b=$("#notifications");b.queue(function(){b.text(a);$(this).dequeue()}).fadeIn(500).delay(3500).fadeOut(500)};var Heatmap=function(a){this._map=a;this.setMap(a);this.setRadius(Heatmap.DEFAULT_RADIUS);this.setHeatMultiplier(Heatmap.DEFAULT_ALPHA_MULTIPLIER);this._hotspots=[];console.log("heatmap ready")};Heatmap.prototype=new google.maps.OverlayView;
Heatmap.prototype.onAdd=function(){this._canvas=document.createElement("canvas");this._ctx=this._canvas.getContext("2d");this.getPanes().overlayLayer.appendChild(this._canvas);this._canvas.width=document.getElementById("map_container").offsetWidth;this._canvas.height=document.getElementById("map_container").offsetHeight;this._width=this._canvas.width;this._height=this._canvas.height;log("Canvas size:"+this._width+" x "+this._height);this._canvas.style.position="absolute";this._canvas.style.left=0;
this._canvas.style.top=0;google.maps.event.addListener(this._map,"dragend",function(){heatmap.draw()})};
Heatmap.prototype.draw=function(){log("Heatmap.draw");var a=this.getProjection();(new Date).getTime();var b=this._map.getBounds();if(b){var c=a.fromLatLngToDivPixel(b.getSouthWest()),a=a.fromLatLngToDivPixel(b.getNorthEast());this._canvas.style.left=c.x+"px";this._canvas.style.top=a.y+"px";log("left:"+c.x+" top:"+a.y);this._ctx.clearRect(0,0,this._width,this._height);c=this._hotspots;a=c.length;for(b=0;b<a;b++)for(var d=c[b],f=MapHelper.fromLatLngToPixel(d.latlng,this._map),d=d.count,g=0;g<d;g++)this.addHeat(f.x,
f.y);this.colorize()}else console.warn("mapBounds are not ready")};Heatmap.prototype.addHotspot=function(a,b){this._hotspots.push({latlng:a,count:b})};Heatmap.prototype.addHeat=function(a,b){var c=this._radius2,d=this._ctx,f=0.1*(this._heatMultiplier||1),g=d.createRadialGradient(a,b,this._radius1,a,b,c);g.addColorStop(0,"rgba(0,0,0,"+f+")");g.addColorStop(1,"rgba(0,0,0,0)");d.fillStyle=g;d.fillRect(a-c,b-c,2*c,2*c)};
Heatmap.prototype.colorize=function(){for(var a=this._ctx,b=a.getImageData(0,0,this._width,this._height),c=b.data,d=c.length,f=3;f<d;f+=4){var g=0,h=0,i=0,e=0,e=c[f];e<=255&&e>=235?(e=255-e,g=255-e,h=e*12):e<=234&&e>=200?(e=234-e,g=255-e*8,h=255):e<=199&&e>=150?(e=199-e,h=255,i=e*5):(e<=149&&e>=100&&(e=149-e,h=255-e*5),i=255);c[f-3]=g;c[f-2]=h;c[f-1]=i}b.data=c;a.putImageData(b,0,0)};Heatmap.DEFAULT_RADIUS=40;Heatmap.DEFAULT_ALPHA_MULTIPLIER=1;
Heatmap.prototype.setRadius=function(a){this._radius2=a;this._radius1=a/2};Heatmap.prototype.setHeatMultiplier=function(a){this._heatMultiplier=a};var MapHelper={fromLatLngToPixel:function(a,b){var c=Math.pow(2,b.getZoom()),d=new google.maps.LatLng(b.getBounds().getNorthEast().lat(),b.getBounds().getSouthWest().lng()),d=b.getProjection().fromLatLngToPoint(d),f=b.getProjection().fromLatLngToPoint(a);return new google.maps.Point(Math.floor((f.x-d.x)*c),Math.floor((f.y-d.y)*c))}};var socket={followEvents:!1,followPolling:!1,grid:[],initializeSocket:function(){log("Initializing socket");socket.socket=new io.Socket(document.domain);socket.socket.on("connect",function(){log("Socket connected!")});socket.socket.on("message",function(a){var a=$.parseJSON(a),b=a.response;if(b==="pollingArea")socket.onPollingArea(a);else if(b==="newEvent")socket.showNewEvent(a.content);else if(b==="pollingGrid")socket.onPollingGrid(a)});socket.socket.on("disconnect",function(){log("Socket disconnected")});
socket.socket.connect()},onPollingGrid:function(a){a=a.content;$.each(socket.grid,function(a,c){c.setMap(null)});socket.grid=[];$.each(a,function(a,c){socket.grid.push(new google.maps.Rectangle({bounds:new google.maps.LatLngBounds(new google.maps.LatLng(c.nwLatLng.lat,c.nwLatLng.lng),new google.maps.LatLng(c.seLatLng.lat,c.seLatLng.lng)),strokeColor:"#000000",strokeOpacity:1,strokeWeight:1,fillOpacity:0,map:map}))})},onPollingArea:function(a){var b=a.content.nwLatLng,a=a.content.seLatLng;socket.followPolling&&
(map.panTo(new google.maps.LatLng((b.lat+a.lat)/2,(b.lng+a.lng)/2)),heatmap.draw());socket.rectangle===null?(socket.rectangle=new google.maps.Rectangle({bounds:new google.maps.LatLngBounds(new google.maps.LatLng(b.lat,b.lng),new google.maps.LatLng(a.lat,a.lng)),strokeColor:"#FF0000",strokeOpacity:0.5,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35}),socket.rectangle.setMap(map)):socket.rectangle.setBounds(new google.maps.LatLngBounds(new google.maps.LatLng(b.lat,b.lng),new google.maps.LatLng(a.lat,
a.lng)))},showNewEvent:function(a){var b=a.venue.events[0].points;$("#fs-event-log ul").append("<li>"+b+" @ "+a.venue.name+"</li>");addVenue(a.venue,socket.followEvents,!0);heatmap.draw();notification(b+" checkin"+(b==1?"":"s")+" @ "+a.venue.name)},showPollingArea:function(){socket.socket.send('{"request": "startPollingAreas"}')},endPollingArea:function(){socket.socket.send('{"request": "stopPollingAreas"}');socket.rectangle.setMap(null);socket.rectangle=null},startPollingGrid:function(){socket.socket.send('{"request": "startPollingGrid"}')},
endPollingGrid:function(){socket.socket.send('{"request": "endPollingGrid"}')},init:function(){$("#fs-search-button").click(function(){getVenues();return!1});$("#fs-hide-console").click(function(){$("#sidebar").hide("slow");$("#sidebar-bg").hide("slow")});$("#fs-hide-canvas").click(function(){$("#canvas").hide("slow")});$("#fs-hide-canvas").click(function(){$("#canvas").hide("slow")});$("#show-polling-area").click(function(){$(this).is(":checked")?(socket.showPollingArea(),$("#follow-polling-area").removeAttr("disabled")):
(socket.endPollingArea(),$("#follow-polling-area").attr("disabled",!0))});$("#follow-polling-area").click(function(){socket.followPolling=$(this).is(":checked")?!0:!1});$("#follow-new-events").click(function(){socket.followEvents=$(this).is(":checked")?!0:!1});socket.initializeSocket()}};$(document).ready(function(){socket.init()});
